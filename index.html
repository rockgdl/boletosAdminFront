<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generar Mesas</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    #container {
      border: 1px solid #ccc;
      flex-grow: 1;
      width: 100%;
    }
    #controls {
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 10px;
      background-color: #f8f8f8;
      border-bottom: 1px solid #ccc;
    }
    button, select, input {
      padding: 10px;
      font-size: 16px;
      margin: 0 10px;
    }
    #feedbackMessage, #remainingPlaces {
      font-size: 16px;
    }
    #feedbackMessage {
      color: red;
    }
    #remainingPlaces {
      color: green;
    }
  </style>
</head>
<body>
  <!-- Contenedor de los controles en la parte superior -->
  <div id="controls">
    <input type="number" id="rectangleCount" placeholder="Cantidad de mesas" min="1">
    <button id="generateRectanglesButton">Generar Mesas</button>
    <select id="rectangleSelect" style="display:none;"></select>
    <button id="addPlacesButton" style="display:none;">Agregar Lugares</button>
  </div>

  <!-- Mensajes de feedback y contador de lugares -->
  <div id="feedbackMessage" style="display: none;"></div>
  <p id="remainingPlaces"></p>

  <!-- Contenedor del canvas -->
  <div id="container"></div>

  <script src="https://unpkg.com/konva@8.4.3/konva.min.js"></script>
  <script>
    var stage = new Konva.Stage({
      container: 'container',
      width: window.innerWidth,
      height: window.innerHeight - document.getElementById('controls').offsetHeight
    });

    var layer = new Konva.Layer();
    stage.add(layer);

    var rects = [];
    var imageSize, padding;

    var imageObj = new Image();
    imageObj.src = 'imagenes/chair.png';

    // Seleccionamos el div del feedback
    var feedbackMessage = document.getElementById('feedbackMessage');

    async function loadJson() {
      try {
        const response = await fetch('data/data.json');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        console.log('Datos JSON cargados:', data);

        if (!data.rectangles || !data.places) {
          throw new Error('Datos JSON faltantes');
        }

        imageSize = data.places[0].size;
        padding = data.places[0].padding;

        layer.destroyChildren();
        rects = [];

        const rectangleCount = parseInt(document.getElementById('rectangleCount').value) || 2;

        const rectWidth = data.rectangles[0].width;
        const rectHeight = data.rectangles[0].height;
        const spacing = 70;

        const margin = 50;
        const availableWidth = stage.width() - 2 * margin;
        const rectsPerRow = Math.floor(availableWidth / (rectWidth + spacing));

        const rectangleSelect = document.getElementById('rectangleSelect');
        rectangleSelect.innerHTML = ''; // Limpiar el select

        for (let i = 0; i < rectangleCount; i++) {
          const rectData = data.rectangles[i % data.rectangles.length];

          const x = (i % rectsPerRow) * (rectWidth + spacing) + margin;
          const y = Math.floor(i / rectsPerRow) * (rectHeight + spacing) + margin;

          const rectId = `rect-${i + 1}`;
          const rect = new Konva.Rect({
            x: x,
            y: y,
            width: rectData.width,
            height: rectData.height,
            fill: rectData.color,
            stroke: 'black',
            strokeWidth: 2,
            rectId: rectId
          });
          rects.push(rect);
          layer.add(rect);

          const text = new Konva.Text({
            x: x,
            y: y + rectData.height / 2 - 10,
            text: `Mesa ${i + 1}`,
            fontSize: 18,
            fontFamily: 'Calibri',
            fill: 'white',
            width: rectData.width,
            align: 'center'
          });
          layer.add(text);

          const option = document.createElement('option');
          option.value = rectId;
          option.text = `Mesa ${i + 1}`;
          rectangleSelect.appendChild(option);
        }

        layer.draw();
        document.getElementById('addPlacesButton').style.display = 'inline-block';
        rectangleSelect.style.display = 'inline-block';

        // Actualizar el contador de lugares restantes para la primera mesa
        updateRemainingPlaces(rectangleSelect.value);

      } catch (error) {
        console.error('Error al cargar el archivo JSON:', error);
      }
    }

    function updateRemainingPlaces(selectedRectId) {
      const specificRect = rects.find(rect => rect.attrs.rectId === selectedRectId);
      const chairCount = specificRect.chairCount || 0;
      const remaining = 10 - chairCount;  // Máximo 10 sillas por mesa

      document.getElementById('remainingPlaces').innerHTML = `Lugares restantes para la mesa ${selectedRectId.split('-')[1]}: ${remaining}`;
    }

    function addPlaces() {
      const selectedRectId = document.getElementById('rectangleSelect').value;
      const specificRect = rects.find(rect => rect.attrs.rectId === selectedRectId);

      if (!specificRect) {
        console.log("No se encontró la mesa seleccionada.");
        return;
      }

      const chairCount = specificRect.chairCount || 0;

      if (chairCount >= 10) {
        const mesaNumero = selectedRectId.split('-')[1];
        feedbackMessage.innerHTML = `Ya no hay más lugares disponibles en la Mesa ${mesaNumero}.`;
        feedbackMessage.style.display = 'block';
        return;
      }

      const rectWidth = specificRect.width();
      const rectHeight = specificRect.height();
      const x = specificRect.x();
      const y = specificRect.y();

      const places = [
        { x: x - imageSize - padding, y: y - imageSize - padding },
        { x: x + rectWidth + padding, y: y - imageSize - padding },
        { x: x - imageSize - padding, y: y + rectHeight + padding },
        { x: x + rectWidth + padding, y: y + rectHeight + padding },
        { x: x + rectWidth / 4 - imageSize / 2, y: y - imageSize - padding },
        { x: x + (3 * rectWidth) / 4 - imageSize / 2, y: y - imageSize - padding },
        { x: x + rectWidth / 4 - imageSize / 2, y: y + rectHeight + padding },
        { x: x + (3 * rectWidth) / 4 - imageSize / 2, y: y + rectHeight + padding },
        { x: x - imageSize - padding, y: y + rectHeight / 2 - imageSize / 2 },
        { x: x + rectWidth + padding, y: y + rectHeight / 2 - imageSize / 2 }
      ];

      const place = places[chairCount];

      var image = new Konva.Image({
        x: place.x,
        y: place.y,
        image: imageObj,
        width: imageSize,
        height: imageSize
      });

      layer.add(image);
      layer.batchDraw();

      specificRect.chairCount = chairCount + 1;

      updateRemainingPlaces(selectedRectId);
      feedbackMessage.style.display = 'none';
    }

    document.getElementById('rectangleSelect').addEventListener('change', function() {
      const selectedRectId = this.value;
      updateRemainingPlaces(selectedRectId);
      feedbackMessage.style.display = 'none';
    });

    document.getElementById('generateRectanglesButton').addEventListener('click', loadJson);
    document.getElementById('addPlacesButton').addEventListener('click', addPlaces);

    window.addEventListener('resize', () => {
      stage.width(window.innerWidth);
      stage.height(window.innerHeight - document.getElementById('controls').offsetHeight);
    });
  </script>
</body>
</html>
